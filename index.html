<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Liked Video Indexer</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background-color: #000; color: #fff; }
        .video-card { background: #1c1c1e; border-radius: 12px; transition: transform 0.2s; }
        .video-card:hover { transform: scale(1.02); }
        .badge { background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .filter-chip { 
            padding: 6px 12px; border-radius: 20px; border: 1px solid #3a3a3c; 
            font-size: 0.85rem; cursor: pointer; white-space: nowrap;
        }
        .filter-chip.active { background: #007aff; border-color: #007aff; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3a3a3c; border-radius: 10px; }
        .error-pre { background: #2c0000; color: #ff8888; padding: 10px; border-radius: 8px; font-size: 10px; overflow-x: auto; margin-top: 10px; text-align: left; }
    </style>
</head>
<body>

<div class="p-4 max-w-4xl mx-auto">
    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-bold">Liked Indexer</h1>
            <p id="stats-text" class="text-gray-500 text-sm">Not indexed yet</p>
        </div>
        <button id="index-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
            Index Videos
        </button>
    </header>

    <!-- Search & Sort -->
    <div class="space-y-4 mb-6">
        <input type="text" id="search-bar" placeholder="Search by title..." class="w-full bg-[#1c1c1e] border border-[#3a3a3c] rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500">
        
        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
            <select id="sort-select" class="bg-[#1c1c1e] border border-[#3a3a3c] rounded-lg px-3 py-2 text-sm outline-none">
                <option value="date-new">Date: Newest</option>
                <option value="date-old">Date: Oldest</option>
                <option value="dur-long">Length: Longest</option>
                <option value="dur-short">Length: Shortest</option>
                <option value="views">Most Views</option>
            </select>

            <select id="res-filter" class="bg-[#1c1c1e] border border-[#3a3a3c] rounded-lg px-3 py-2 text-sm outline-none">
                <option value="all">Any Quality</option>
                <option value="4k">4K / UHD</option>
                <option value="1080">1080p</option>
                <option value="720">720p</option>
                <option value="480">480p</option>
            </select>

            <div id="len-chips" class="flex gap-2">
                <div class="filter-chip active" data-len="all">All</div>
                <div class="filter-chip" data-len="short">Short (&lt;5m)</div>
                <div class="filter-chip" data-len="med">Medium</div>
                <div class="filter-chip" data-len="long">Long (20m+)</div>
            </div>
        </div>
    </div>

    <!-- Grid -->
    <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <!-- Videos rendered here -->
    </div>

    <div id="loading-overlay" class="hidden text-center py-10 bg-black/80 fixed inset-0 z-50 flex flex-col items-center justify-center p-6">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-4"></div>
        <p id="loading-text" class="text-gray-200 font-medium">Requesting permissions...</p>
        <div id="error-details" class="hidden w-full max-w-sm">
            <p class="text-red-400 text-sm mt-4">Technical Error Details:</p>
            <pre id="error-log" class="error-pre"></pre>
            <button onclick="location.reload()" class="mt-4 text-xs text-blue-400 underline">Refresh and try again</button>
        </div>
    </div>
</div>

<script>
    const APP_ID = 53969951; 
    let indexedVideos = [];
    let accessToken = '';

    const grid = document.getElementById('video-grid');
    const indexBtn = document.getElementById('index-btn');
    const statsText = document.getElementById('stats-text');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const errorDetails = document.getElementById('error-details');
    const errorLog = document.getElementById('error-log');
    const searchBar = document.getElementById('search-bar');
    const sortSelect = document.getElementById('sort-select');
    const resFilter = document.getElementById('res-filter');
    const lenChips = document.querySelectorAll('.filter-chip');

    // Initialize VK Bridge
    vkBridge.send('VKWebAppInit').catch(e => console.error("Init failed", e));

    async function init() {
        try {
            const cached = localStorage.getItem('indexed_liked_videos');
            if (cached) {
                indexedVideos = JSON.parse(cached);
                updateStats();
                applyFilters();
            }
        } catch (e) {
            console.error("Cache load failed", e);
        }
    }

    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    indexBtn.addEventListener('click', async () => {
        indexBtn.disabled = true;
        loadingOverlay.classList.remove('hidden');
        errorDetails.classList.add('hidden');
        loadingText.innerText = "Requesting access token...";
        
        try {
            // Request token
            const auth = await vkBridge.send('VKWebAppGetAuthToken', { 
                app_id: APP_ID, 
                scope: 'video,fave,offline' // 'offline' helps token longevity
            });

            if (!auth.access_token) {
                throw new Error("No access token returned by VK Bridge");
            }
            
            accessToken = auth.access_token;
            grid.innerHTML = '';
            let allItems = [];
            let offset = 0;
            let hasMore = true;

            while (hasMore) {
                loadingText.innerText = `Indexing: ${allItems.length} found (Offset: ${offset})`;
                
                const response = await vkBridge.send('VKWebAppCallAPIMethod', {
                    method: 'fave.get',
                    params: { 
                        item_type: 'video', 
                        count: 50, 
                        offset: offset, 
                        extended: 1, 
                        v: '5.131', 
                        access_token: accessToken 
                    }
                });

                // Error handling for API method call
                if (response.error_type || response.error_data) {
                    throw response;
                }

                const rawItems = response.response?.items || [];
                if (rawItems.length === 0) {
                    hasMore = false;
                } else {
                    const videos = rawItems
                        .map(item => item.video || item)
                        .filter(v => v && v.id);
                    
                    allItems = allItems.concat(videos);
                    offset += 50;
                    
                    // Safety break
                    if (offset >= 3000) hasMore = false;
                    
                    // Small delay to prevent hitting VK rate limits (Too many requests)
                    await sleep(200); 
                }
            }

            if (allItems.length === 0) {
                loadingText.innerText = "Finished. 0 liked videos found.";
                setTimeout(() => loadingOverlay.classList.add('hidden'), 2000);
            } else {
                indexedVideos = allItems;
                localStorage.setItem('indexed_liked_videos', JSON.stringify(indexedVideos));
                updateStats();
                applyFilters();
                loadingOverlay.classList.add('hidden');
            }

        } catch (e) {
            console.error("Critical Error:", e);
            loadingText.innerText = "Operation Failed";
            errorDetails.classList.remove('hidden');
            
            // Show the actual error content so we can debug
            const msg = e.error_data?.error_msg || e.message || "Unknown Error Object";
            errorLog.innerText = JSON.stringify(e, null, 2);
            
            // Specific hint for App ID mismatch
            if (JSON.stringify(e).includes("invalid app_id")) {
                errorLog.innerText += "\n\nHINT: The App ID in your code (" + APP_ID + ") doesn't match the one in your VK dashboard.";
            }
        } finally {
            indexBtn.disabled = false;
        }
    });

    function updateStats() {
        statsText.innerText = `Total: ${indexedVideos.length} videos indexed`;
    }

    function formatDuration(sec) {
        if (!sec) return "0:00";
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        return h > 0 ? `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}` : `${m}:${s.toString().padStart(2,'0')}`;
    }

    function getResolution(v) {
        const w = v.width || 0;
        const h = v.height || 0;
        if (w >= 3840 || h >= 2160) return "4K";
        if (w >= 1920 || h >= 1080) return "1080p";
        if (w >= 1280 || h >= 720) return "720p";
        if (h >= 480) return "480p";
        return h ? h + "p" : "";
    }

    function render(list) {
        if (list.length === 0 && indexedVideos.length > 0) {
            grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">No match for current filters.</div>';
            return;
        }
        grid.innerHTML = list.map(v => {
            const thumb = v.image?.sort((a,b) => b.width - a.width)[0]?.url || v.photo_320 || v.photo_130 || '';
            const res = getResolution(v);
            return `
                <a href="https://vk.com/video${v.owner_id}_${v.id}" target="_blank" class="video-card block overflow-hidden">
                    <div class="relative">
                        <img src="${thumb}" class="w-full aspect-video object-cover bg-gray-900" onerror="this.src='https://placehold.co/400x225/1c1c1e/3a3a3c?text=No+Preview'">
                        <div class="absolute bottom-2 right-2 flex gap-1">
                            ${res ? `<span class="badge bg-blue-600 text-white">${res}</span>` : ''}
                            <span class="badge text-white">${formatDuration(v.duration)}</span>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-medium line-clamp-2 mb-1">${v.title || 'Untitled Video'}</h3>
                        <p class="text-xs text-gray-500">${Number(v.views || 0).toLocaleString()} views</p>
                    </div>
                </a>
            `;
        }).join('');
    }

    function applyFilters() {
        let list = [...indexedVideos];
        const query = searchBar.value.toLowerCase();
        if (query) list = list.filter(v => (v.title || '').toLowerCase().includes(query));

        const resVal = resFilter.value;
        if (resVal !== 'all') {
            list = list.filter(v => getResolution(v).toLowerCase().includes(resVal));
        }

        const activeChip = document.querySelector('.filter-chip.active').dataset.len;
        if (activeChip !== 'all') {
            list = list.filter(v => {
                const dur = v.duration || 0;
                if (activeChip === 'short') return dur < 300;
                if (activeChip === 'med') return dur >= 300 && dur < 1200;
                if (activeChip === 'long') return dur >= 1200;
            });
        }

        const sortVal = sortSelect.value;
        list.sort((a, b) => {
            const dateA = a.adding_date || a.date || 0;
            const dateB = b.adding_date || b.date || 0;
            if (sortVal === 'date-new') return dateB - dateA;
            if (sortVal === 'date-old') return dateA - dateB;
            if (sortVal === 'dur-long') return (b.duration || 0) - (a.duration || 0);
            if (sortVal === 'dur-short') return (a.duration || 0) - (b.duration || 0);
            if (sortVal === 'views') return (b.views || 0) - (a.views || 0);
        });

        render(list);
    }

    searchBar.addEventListener('input', applyFilters);
    sortSelect.addEventListener('change', applyFilters);
    resFilter.addEventListener('change', applyFilters);
    lenChips.forEach(chip => {
        chip.addEventListener('click', () => {
            lenChips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            applyFilters();
        });
    });

    init();
</script>

</body>
</html>
