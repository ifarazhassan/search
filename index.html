<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Liked Video Indexer</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background-color: #000; color: #fff; }
        .video-card { background: #1c1c1e; border-radius: 12px; transition: transform 0.2s; }
        .video-card:hover { transform: scale(1.02); }
        .badge { background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .filter-chip { 
            padding: 6px 12px; border-radius: 20px; border: 1px solid #3a3a3c; 
            font-size: 0.85rem; cursor: pointer; white-space: nowrap;
        }
        .filter-chip.active { background: #007aff; border-color: #007aff; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3a3a3c; border-radius: 10px; }
    </style>
</head>
<body>

<div class="p-4 max-w-4xl mx-auto">
    <!-- Header -->
    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-bold">Liked Indexer</h1>
            <p id="stats-text" class="text-gray-500 text-sm">Not indexed yet</p>
        </div>
        <button id="index-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
            Index Videos
        </button>
    </header>

    <!-- Search & Sort -->
    <div class="space-y-4 mb-6">
        <input type="text" id="search-bar" placeholder="Search by title..." class="w-full bg-[#1c1c1e] border border-[#3a3a3c] rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500">
        
        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
            <select id="sort-select" class="bg-[#1c1c1e] border border-[#3a3a3c] rounded-lg px-3 py-2 text-sm outline-none">
                <option value="date-new">Date: Newest</option>
                <option value="date-old">Date: Oldest</option>
                <option value="dur-long">Length: Longest</option>
                <option value="dur-short">Length: Shortest</option>
                <option value="views">Most Views</option>
            </select>

            <select id="res-filter" class="bg-[#1c1c1e] border border-[#3a3a3c] rounded-lg px-3 py-2 text-sm outline-none">
                <option value="all">Any Quality</option>
                <option value="4k">4K / UHD</option>
                <option value="1080">1080p</option>
                <option value="720">720p</option>
                <option value="480">480p</option>
            </select>

            <div id="len-chips" class="flex gap-2">
                <div class="filter-chip active" data-len="all">All</div>
                <div class="filter-chip" data-len="short">Short (&lt;5m)</div>
                <div class="filter-chip" data-len="med">Medium</div>
                <div class="filter-chip" data-len="long">Long (20m+)</div>
            </div>
        </div>
    </div>

    <!-- Grid -->
    <div id="video-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <!-- Videos rendered here -->
    </div>

    <div id="loading-overlay" class="hidden text-center py-20">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-4"></div>
        <p id="loading-text" class="text-gray-400">Fetching videos from VK...</p>
    </div>
</div>

<script>
    const APP_ID = 53969951; 
    let indexedVideos = [];
    let accessToken = '';

    // Elements
    const grid = document.getElementById('video-grid');
    const indexBtn = document.getElementById('index-btn');
    const statsText = document.getElementById('stats-text');
    const loadingOverlay = document.getElementById('loading-overlay');
    const searchBar = document.getElementById('search-bar');
    const sortSelect = document.getElementById('sort-select');
    const resFilter = document.getElementById('res-filter');
    const lenChips = document.querySelectorAll('.filter-chip');

    vkBridge.send('VKWebAppInit');

    // Initialization
    async function init() {
        try {
            const data = await vkBridge.send('VKWebAppGetAuthToken', { app_id: APP_ID, scope: 'video,fave' });
            accessToken = data.access_token;
            // Load from cache if exists
            const cached = localStorage.getItem('indexed_liked_videos');
            if (cached) {
                indexedVideos = JSON.parse(cached);
                updateStats();
                applyFilters();
            }
        } catch (e) {
            console.error(e);
        }
    }

    // Indexing Logic
    indexBtn.addEventListener('click', async () => {
        if (!accessToken) return;
        indexBtn.disabled = true;
        loadingOverlay.classList.remove('hidden');
        grid.innerHTML = '';
        
        let allItems = [];
        let offset = 0;
        let hasMore = true;

        try {
            while (hasMore) {
                document.getElementById('loading-text').innerText = `Indexing: Found ${allItems.length} videos...`;
                const response = await vkBridge.send('VKWebAppCallAPIMethod', {
                    method: 'fave.get',
                    params: { 
                        item_type: 'video', 
                        count: 50, 
                        offset: offset, 
                        extended: 1, 
                        v: '5.131', 
                        access_token: accessToken 
                    }
                });

                const items = response.response.items.map(item => item.video);
                if (items.length === 0) {
                    hasMore = false;
                } else {
                    allItems = allItems.concat(items);
                    offset += 50;
                    // Limit to 1000 for stability in preview, remove or increase for production
                    if (offset >= 10) hasMore = false; 
                }
            }

            indexedVideos = allItems;
            localStorage.setItem('indexed_liked_videos', JSON.stringify(indexedVideos));
            updateStats();
            applyFilters();
        } catch (e) {
            console.error(e);
        } finally {
            loadingOverlay.classList.add('hidden');
            indexBtn.disabled = false;
        }
    });

    function updateStats() {
        statsText.innerText = `Total: ${indexedVideos.length} videos indexed`;
    }

    function formatDuration(sec) {
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        return h > 0 ? `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}` : `${m}:${s.toString().padStart(2,'0')}`;
    }

    function getResolution(v) {
        if (v.width >= 3840) return "4K";
        if (v.width >= 1920 || v.height >= 1080) return "1080p";
        if (v.width >= 1280 || v.height >= 720) return "720p";
        if (v.height >= 480) return "480p";
        return v.height ? v.height + "p" : "";
    }

    function render(list) {
        grid.innerHTML = list.map(v => {
            const thumb = v.image?.sort((a,b) => b.width - a.width)[0]?.url || '';
            const res = getResolution(v);
            return `
                <a href="https://vk.com/video${v.owner_id}_${v.id}" target="_blank" class="video-card block overflow-hidden">
                    <div class="relative">
                        <img src="${thumb}" class="w-full aspect-video object-cover">
                        <div class="absolute bottom-2 right-2 flex gap-1">
                            ${res ? `<span class="badge bg-blue-600 text-white">${res}</span>` : ''}
                            <span class="badge text-white">${formatDuration(v.duration)}</span>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-medium line-clamp-2 mb-1">${v.title}</h3>
                        <p class="text-xs text-gray-500">${Number(v.views || 0).toLocaleString()} views</p>
                    </div>
                </a>
            `;
        }).join('');
    }

    function applyFilters() {
        let list = [...indexedVideos];

        // Search
        const query = searchBar.value.toLowerCase();
        if (query) list = list.filter(v => v.title.toLowerCase().includes(query));

        // Resolution
        const resVal = resFilter.value;
        if (resVal !== 'all') {
            list = list.filter(v => {
                const r = getResolution(v).toLowerCase();
                if (resVal === '4k') return r.includes('4k');
                return r.includes(resVal);
            });
        }

        // Duration Chip
        const activeChip = document.querySelector('.filter-chip.active').dataset.len;
        if (activeChip !== 'all') {
            list = list.filter(v => {
                if (activeChip === 'short') return v.duration < 300;
                if (activeChip === 'med') return v.duration >= 300 && v.duration < 1200;
                if (activeChip === 'long') return v.duration >= 1200;
            });
        }

        // Sorting
        const sortVal = sortSelect.value;
        list.sort((a, b) => {
            if (sortVal === 'date-new') return b.adding_date - a.adding_date;
            if (sortVal === 'date-old') return a.adding_date - b.adding_date;
            if (sortVal === 'dur-long') return b.duration - a.duration;
            if (sortVal === 'dur-short') return a.duration - b.duration;
            if (sortVal === 'views') return (b.views || 0) - (a.views || 0);
        });

        render(list);
    }

    // UI Listeners
    searchBar.addEventListener('input', applyFilters);
    sortSelect.addEventListener('change', applyFilters);
    resFilter.addEventListener('change', applyFilters);
    lenChips.forEach(chip => {
        chip.addEventListener('click', () => {
            lenChips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            applyFilters();
        });
    });

    init();
</script>

</body>
</html>
