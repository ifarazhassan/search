import React, { useState, useEffect } from 'react';
import { Search, SlidersHorizontal, PlayCircle, Clock, Video, ArrowUpDown, RefreshCw, Download, AlertCircle } from 'lucide-react';

const VKVideoManager = () => {
  const [videos, setVideos] = useState([]);
  const [filteredVideos, setFilteredVideos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [sortBy, setSortBy] = useState('date');
  const [sortOrder, setSortOrder] = useState('desc');
  const [showFilters, setShowFilters] = useState(false);
  const [vkBridgeReady, setVkBridgeReady] = useState(false);
  
  const APP_ID = 53969951;
  
  // Filter states
  const [filters, setFilters] = useState({
    minDuration: '',
    maxDuration: '',
    minViews: '',
    resolution: 'all',
    dateFrom: '',
    dateTo: ''
  });

  // Initialize VK Bridge
  useEffect(() => {
    const initVK = async () => {
      try {
        // Check if VK Bridge is available
        if (window.vkBridge) {
          await window.vkBridge.send('VKWebAppInit');
          setVkBridgeReady(true);
          
          // Auto-fetch videos on load
          fetchLikedVideos();
        } else {
          setError('VK Bridge not available. Please run this app inside VK.');
        }
      } catch (err) {
        console.error('VK initialization error:', err);
        setError('Failed to initialize VK Bridge: ' + err.message);
      }
    };
    
    initVK();
  }, []);

  // Fetch liked videos from VK API
  const fetchLikedVideos = async () => {
    setLoading(true);
    setError(null);
    
    try {
      // First, get auth token if needed
      let accessToken = null;
      
      try {
        const authResult = await window.vkBridge.send('VKWebAppGetAuthToken', {
          app_id: APP_ID,
          scope: 'video'
        });
        accessToken = authResult.access_token;
      } catch (authError) {
        console.log('Using user token from context');
      }

      // Fetch liked videos
      const result = await window.vkBridge.send('VKWebAppCallAPIMethod', {
        method: 'fave.getVideos',
        params: {
          v: '5.131',
          count: 100,
          offset: 0,
          extended: 1
        }
      });

      if (result.response && result.response.items) {
        const formattedVideos = result.response.items.map(video => {
          // Determine resolution based on video dimensions
          let resolution = '480p';
          if (video.width) {
            if (video.width >= 3840) resolution = '4K';
            else if (video.width >= 1920) resolution = '1080p';
            else if (video.width >= 1280) resolution = '720p';
          }

          // Get best quality thumbnail
          const thumbnail = video.image?.[video.image.length - 1]?.url || 
                           video.photo_320 || 
                           video.photo_640 ||
                           'https://via.placeholder.com/320x180/667eea/ffffff?text=No+Preview';

          return {
            id: `${video.owner_id}_${video.id}`,
            vk_id: video.id,
            owner_id: video.owner_id,
            title: video.title || 'Untitled Video',
            duration: video.duration || 0,
            views: video.views || 0,
            date: new Date(video.date * 1000),
            thumbnail: thumbnail,
            resolution: resolution,
            owner_name: video.owner_title || 'Unknown',
            description: video.description || '',
            player: video.player,
            width: video.width,
            height: video.height,
            added_date: video.added_date ? new Date(video.added_date * 1000) : null
          };
        });

        setVideos(formattedVideos);
        setFilteredVideos(formattedVideos);
      } else {
        setError('No videos found in your liked videos.');
      }
    } catch (err) {
      console.error('Error fetching videos:', err);
      setError(`Failed to fetch videos: ${err.message}`);
      
      // Load sample data as fallback for testing
      loadSampleData();
    }
    
    setLoading(false);
  };

  // Sample data for testing outside VK environment
  const loadSampleData = () => {
    const sampleVideos = [
      {
        id: "sample_1",
        vk_id: 1,
        owner_id: -1,
        title: "Amazing Nature Documentary",
        duration: 3600,
        views: 125000,
        date: new Date('2024-01-15'),
        thumbnail: "https://via.placeholder.com/320x180/667eea/ffffff?text=Video+1",
        resolution: "1080p",
        owner_name: "Nature Channel",
        description: "Explore the beauty of nature",
        width: 1920,
        height: 1080
      },
      {
        id: "sample_2",
        vk_id: 2,
        owner_id: -2,
        title: "Cooking Tutorial: Italian Pasta",
        duration: 900,
        views: 45000,
        date: new Date('2024-02-20'),
        thumbnail: "https://via.placeholder.com/320x180/764ba2/ffffff?text=Video+2",
        resolution: "720p",
        owner_name: "Chef's Kitchen",
        description: "Learn to make authentic Italian pasta",
        width: 1280,
        height: 720
      },
      {
        id: "sample_3",
        vk_id: 3,
        owner_id: -3,
        title: "Tech Review: Latest Smartphone",
        duration: 1200,
        views: 89000,
        date: new Date('2024-03-10'),
        thumbnail: "https://via.placeholder.com/320x180/f093fb/ffffff?text=Video+3",
        resolution: "4K",
        owner_name: "Tech Reviews",
        description: "Comprehensive smartphone review",
        width: 3840,
        height: 2160
      },
      {
        id: "sample_4",
        vk_id: 4,
        owner_id: -4,
        title: "Workout Routine for Beginners",
        duration: 1800,
        views: 67000,
        date: new Date('2024-01-25'),
        thumbnail: "https://via.placeholder.com/320x180/4facfe/ffffff?text=Video+4",
        resolution: "1080p",
        owner_name: "Fitness Pro",
        description: "Get fit with this beginner routine",
        width: 1920,
        height: 1080
      },
      {
        id: "sample_5",
        vk_id: 5,
        owner_id: -5,
        title: "Travel Vlog: Japan Adventure",
        duration: 2400,
        views: 156000,
        date: new Date('2024-02-05'),
        thumbnail: "https://via.placeholder.com/320x180/00f2fe/ffffff?text=Video+5",
        resolution: "4K",
        owner_name: "Travel Stories",
        description: "Exploring the streets of Tokyo",
        width: 3840,
        height: 2160
      }
    ];
    setVideos(sampleVideos);
    setFilteredVideos(sampleVideos);
  };

  // Format duration to readable time
  const formatDuration = (seconds) => {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  };

  // Open video in VK
  const openVideo = (video) => {
    if (window.vkBridge && video.owner_id && video.vk_id) {
      window.vkBridge.send('VKWebAppOpenApp', {
        app_id: 6446047,
        location: `video${video.owner_id}_${video.vk_id}`
      }).catch(() => {
        // Fallback to opening URL
        if (video.player) {
          window.open(video.player, '_blank');
        } else {
          window.open(`https://vk.com/video${video.owner_id}_${video.vk_id}`, '_blank');
        }
      });
    } else if (video.player) {
      window.open(video.player, '_blank');
    }
  };

  // Apply filters and sorting
  useEffect(() => {
    let result = [...videos];

    // Search filter
    if (searchTerm) {
      result = result.filter(video =>
        video.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
        video.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
        video.owner_name.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    // Duration filters
    if (filters.minDuration) {
      result = result.filter(video => video.duration >= parseInt(filters.minDuration) * 60);
    }
    if (filters.maxDuration) {
      result = result.filter(video => video.duration <= parseInt(filters.maxDuration) * 60);
    }

    // Views filter
    if (filters.minViews) {
      result = result.filter(video => video.views >= parseInt(filters.minViews));
    }

    // Resolution filter
    if (filters.resolution !== 'all') {
      result = result.filter(video => video.resolution === filters.resolution);
    }

    // Date filters
    if (filters.dateFrom) {
      result = result.filter(video => video.date >= new Date(filters.dateFrom));
    }
    if (filters.dateTo) {
      result = result.filter(video => video.date <= new Date(filters.dateTo));
    }

    // Sorting
    result.sort((a, b) => {
      let comparison = 0;
      switch (sortBy) {
        case 'title':
          comparison = a.title.localeCompare(b.title);
          break;
        case 'duration':
          comparison = a.duration - b.duration;
          break;
        case 'views':
          comparison = a.views - b.views;
          break;
        case 'date':
          comparison = a.date - b.date;
          break;
        default:
          comparison = 0;
      }
      return sortOrder === 'asc' ? comparison : -comparison;
    });

    setFilteredVideos(result);
  }, [videos, searchTerm, filters, sortBy, sortOrder]);

  const clearFilters = () => {
    setFilters({
      minDuration: '',
      maxDuration: '',
      minViews: '',
      resolution: 'all',
      dateFrom: '',
      dateTo: ''
    });
    setSearchTerm('');
  };

  const exportData = () => {
    const dataStr = JSON.stringify(filteredVideos, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `vk-liked-videos-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-purple-700 p-4">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-2xl shadow-2xl p-6 mb-6">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-3">
              <Video className="text-purple-600" size={36} />
              My Liked Videos
            </h1>
            <button
              onClick={fetchLikedVideos}
              disabled={loading}
              className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition disabled:opacity-50"
            >
              <RefreshCw size={18} className={loading ? 'animate-spin' : ''} />
              {loading ? 'Loading...' : 'Refresh'}
            </button>
          </div>

          {/* Error Display */}
          {error && (
            <div className="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg flex items-start gap-3">
              <AlertCircle className="text-yellow-600 flex-shrink-0 mt-0.5" size={20} />
              <div>
                <p className="text-yellow-800 font-medium">Notice</p>
                <p className="text-yellow-700 text-sm">{error}</p>
                {!vkBridgeReady && (
                  <p className="text-yellow-600 text-xs mt-2">
                    Running in demo mode with sample data. Deploy to VK to see your real videos.
                  </p>
                )}
              </div>
            </div>
          )}

          {/* Search Bar */}
          <div className="relative mb-4">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
            <input
              type="text"
              placeholder="Search by title, description, or channel..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-600 focus:outline-none"
            />
          </div>

          {/* Controls */}
          <div className="flex flex-wrap gap-4 items-center">
            <button
              onClick={() => setShowFilters(!showFilters)}
              className="flex items-center gap-2 bg-gray-100 px-4 py-2 rounded-lg hover:bg-gray-200 transition"
            >
              <SlidersHorizontal size={18} />
              Filters
            </button>

            <div className="flex items-center gap-2">
              <label className="text-sm font-medium text-gray-700">Sort by:</label>
              <select
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value)}
                className="border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-600 focus:outline-none"
              >
                <option value="date">Date</option>
                <option value="title">Title</option>
                <option value="duration">Duration</option>
                <option value="views">Views</option>
              </select>

              <button
                onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
                className="p-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
                title={sortOrder === 'asc' ? 'Ascending' : 'Descending'}
              >
                <ArrowUpDown size={18} />
              </button>
            </div>

            <button
              onClick={exportData}
              className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition ml-auto"
            >
              <Download size={18} />
              Export
            </button>
          </div>

          {/* Filter Panel */}
          {showFilters && (
            <div className="mt-4 p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Min Duration (minutes)
                  </label>
                  <input
                    type="number"
                    value={filters.minDuration}
                    onChange={(e) => setFilters({...filters, minDuration: e.target.value})}
                    className="w-full border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-600 focus:outline-none"
                    placeholder="0"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Max Duration (minutes)
                  </label>
                  <input
                    type="number"
                    value={filters.maxDuration}
                    onChange={(e) => setFilters({...filters, maxDuration: e.target.value})}
                    className="w-full border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-600 focus:outline-none"
                    placeholder="âˆž"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Min Views
                  </label>
                  <input
                    type="number"
                    value={filters.minViews}
                    onChange={(e) => setFilters({...filters, minViews: e.target.value})}
                    className="w-full border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-600 focus:outline-none"
                    placeholder="0"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Resolution
                  </label>
                  <select
                    value={filters.resolution}
                    onChange={(e) => setFilters({...filters, resolution: e.target.value})}
                    className="w-full border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-600 focus:outline-none"
                  >
                    <option value="all">All</option>
                    <option value="4K">4K</option>
                    <option value="1080p">1080p</option>
                    <option value="720p">720p</option>
                    <option value="480p">480p</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Date From
                  </label>
                  <input
                    type="date"
                    value={filters.dateFrom}
                    onChange={(e) => setFilters({...filters, dateFrom: e.target.value})}
                    className="w-full border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-600 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Date To
                  </label>
                  <input
                    type="date"
                    value={filters.dateTo}
                    onChange={(e) => setFilters({...filters, dateTo: e.target.value})}
                    className="w-full border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-600 focus:outline-none"
                  />
                </div>
              </div>

              <button
                onClick={clearFilters}
                className="mt-4 text-purple-600 hover:text-purple-700 font-medium"
              >
                Clear all filters
              </button>
            </div>
          )}

          {/* Results Count */}
          <div className="mt-4 text-sm text-gray-600">
            Showing {filteredVideos.length} of {videos.length} videos
          </div>
        </div>

        {/* Video Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredVideos.map((video) => (
            <div
              key={video.id}
              className="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all transform hover:-translate-y-1"
            >
              <div className="relative">
                <img
                  src={video.thumbnail}
                  alt={video.title}
                  className="w-full h-48 object-cover"
                />
                <div className="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white px-2 py-1 rounded text-sm flex items-center gap-1">
                  <Clock size={14} />
                  {formatDuration(video.duration)}
                </div>
                <div className="absolute top-2 right-2 bg-purple-600 text-white px-2 py-1 rounded text-xs font-bold">
                  {video.resolution}
                </div>
              </div>

              <div className="p-4">
                <h3 className="font-bold text-lg text-gray-800 mb-2 line-clamp-2">
                  {video.title}
                </h3>
                <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                  {video.description}
                </p>
                <div className="flex items-center justify-between text-sm text-gray-500">
                  <span>{video.owner_name}</span>
                  <span className="flex items-center gap-1">
                    <PlayCircle size={14} />
                    {video.views.toLocaleString()}
                  </span>
                </div>
                <div className="mt-2 text-xs text-gray-400">
                  {video.date.toLocaleDateString()}
                </div>
                <button 
                  onClick={() => openVideo(video)}
                  className="mt-3 w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2"
                >
                  <PlayCircle size={18} />
                  Watch Video
                </button>
              </div>
            </div>
          ))}
        </div>

        {filteredVideos.length === 0 && !loading && (
          <div className="bg-white rounded-2xl shadow-lg p-12 text-center">
            <Video size={64} className="mx-auto text-gray-300 mb-4" />
            <h3 className="text-xl font-bold text-gray-800 mb-2">No videos found</h3>
            <p className="text-gray-600">Try adjusting your filters or search terms</p>
          </div>
        )}
      </div>
    </div>
  );
};

export default VKVideoManager;
